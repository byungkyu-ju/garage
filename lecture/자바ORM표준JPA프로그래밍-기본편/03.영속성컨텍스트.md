# 3.영속성 컨텍스트

- JPA에서 가장 중요한 2가지
  - 객체와 관계형 데이터베이스 매핑하기
  - 영속성 컨텍스트

- 영속성 컨텍스트(Persistence Context)
  - 엔티티 매니저를 통해 접근

- 이점
  - 1차캐시
    - persist단계에서 캐시에 저장해두고, 꺼내씀으로써 IO를 줄여 약간의 성능 향상
  - 동일성 보장

```code
Member a = em.find(Member.class, "member1");
Member b = em.find(Member.class, "member1");
System.out.println(a == b); // true
```

-
  - 엔티티 등록
    - 트랙잭션을 지원하는 **쓰기지연**
    - persist에 저장하더라도 commit을 해야 실제 DB에 반영됨
  - 엔티티 수정
    - **변경감지**
    - 엔티티가 변경되는것만으로도 JPA가 알아서 인식하여 update쿼리문이 생성됨
    - 엔티티와 스냅샷(값을 읽어온 최초시점을 저장)을 비교함
  - 엔티티 삭제
    - 플러시
      - **지연로딩**
      - 영속성 컨텍스트를 비우지 않음
      - 영속성 컨텍스트의 변경내용을 데이터베이스에 동기화
      - 커밋 직전에 동기화하는 작업
- 준영속상태
  - 영속상태의 엔티티가 영속성 컨텍스트에서 분리
  - 만드는 방법
    - em.detach(entity) : 특정 엔티티만 준영속상태로 변경
    - em.clear() : 영속성 컨텍스트를 완전히 초기화
    - em.close() : 영속성 컨텍스트를 종료
